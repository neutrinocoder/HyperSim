<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>p5.js Life Simulation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            font-family: 'Arial', sans-serif;
            color: #fff;
            overflow: hidden;
        }
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px; /* Reduced padding */
            box-sizing: border-box;
        }
        main {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 100%;
            max-width: 900px; /* Added max-width for large screens */
            height: 100%;
        }
        #canvas-container {
            flex-shrink: 0; /* Prevent canvas from shrinking */
        }
        canvas {
            display: block;
            border: 1px solid #444;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            max-width: 100%;
        }
        .controls {
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px; /* Reduced margin */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px; /* Reduced gap */
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            overflow-y: auto; /* Allow scrolling on very small screens */
            flex-shrink: 0;
        }
        .info-display {
            font-size: 1em;
            color: #e0e0e0;
            background-color: #333;
            padding: 10px 15px;
            border-radius: 6px;
            width: 95%;
            text-align: center;
        }
        label {
            font-size: 1em;
            color: #ccc;
        }
        input[type="range"], input[type="number"] {
            background-color: #444;
            border: 1px solid #666;
            color: #fff;
            border-radius: 4px;
            padding: 5px;
        }
        input:disabled {
            background-color: #333;
            opacity: 0.5;
            cursor: not-allowed;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s;
            min-width: 150px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.stop-button {
             background-color: #dc3545;
        }
        button.stop-button:hover {
            background-color: #c82333;
        }
        .mode-switch, .duration-type-switch { display: flex; align-items: center; gap: 10px; }
        .hidden { display: none; }
        .input-group { display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>
    <main>
        <h1>Advanced Life Simulation</h1>
        <div id="canvas-container"></div>
        <div class="controls">
            <div class="info-display" id="info-display">Welcome! Select a mode to begin.</div>
            <div class="mode-switch">
                <label>Normal Mode</label>
                <input type="checkbox" id="mode-toggle">
                <label>Hyper Mode</label>
            </div>
            
            <!-- Normal Mode Controls -->
            <div id="normal-controls">
                <label for="day-length-slider">Day Length: <span id="day-length-value">10</span>s</label>
                <input type="range" id="day-length-slider" min="5" max="60" value="10">
            </div>

            <!-- Hyper Mode Controls -->
            <div id="hyper-controls" class="hidden">
                 <div class="duration-type-switch">
                    <label>Duration:</label>
                    <input type="radio" id="years-radio" name="duration-type" value="years" checked>
                    <label for="years-radio">Years</label>
                    <input type="radio" id="days-radio" name="duration-type" value="days">
                    <label for="days-radio">Days</label>
                 </div>
                 <div class="input-group">
                    <label for="years-input">Years:</label>
                    <input type="number" id="years-input" value="10" min="1">
                 </div>
                 <div class="input-group">
                    <label for="days-input">Days:</label>
                    <input type="number" id="days-input" value="1000" min="1">
                </div>
            </div>

            <button id="main-button">Restart</button>
            <p style="margin: 0; color: #999;">Predators eat Boids. Boids eat Bugs.</p>
        </div>
    </main>
    <script>
        // --- Simulation Core Variables ---
        let boids = [];
        let bugs = [];
        let eggs = [];
        let predators = [];
        const initialBoids = 10;
        const initialBugs = 200;
        const initialPredators = 4;
        const daysPerYear = 365;
        const boidMaxAgeInDays = 15 * daysPerYear;
        const predatorMaxAgeInDays = 10 * daysPerYear;

        // --- State Management ---
        let simulationMode = 'normal';
        let isSimulating = false;
        let isSimComplete = false;
        let isPaused = false;
        let dayCounter = 1;
        
        // FIX: Re-declared missing global state variables
        // --- Normal Mode Variables ---
        let dayLengthMillis = 10000;
        let dayStartTime = 0;
        let pauseEndTime = 0;
        
        // --- Hyper Mode Variables ---
        let hyperSimTotalDays = 0;
        
        // FIX: Declared all UI elements globally for consistent access
        // --- UI Elements ---
        let infoDisplay, modeToggle, mainButton, normalControls, hyperControls, dayLengthSlider, dayLengthValueSpan, yearsInput, daysInput, yearsRadio, daysRadio;

        function setup() {
            let canvas = createCanvas(windowWidth * 0.9, windowHeight * 0.55);
            canvas.parent('canvas-container');
            initializeUI();
            resetSimulation();
        }

        function draw() {
            background(10, 20, 30);

            if (simulationMode === 'normal' && isSimulating) {
                runNormalMode();
            } else if (simulationMode === 'hyper' && isSimulating) {
                runHyperMode();
            }
            
            drawBugsAndEggs();
            drawBoids();
            drawPredators();

            if (isPaused) {
                displayPauseMessage();
            }
        }
        
        function runNormalMode() {
            const timeElapsed = millis() - dayStartTime;
            if (!isPaused && timeElapsed > dayLengthMillis) {
                isPaused = true;
                pauseEndTime = millis() + 1000;
                endOfDay();
            }

            if (isPaused && millis() > pauseEndTime) {
                startNewDay();
            }

            if(!isPaused) {
                 const timeLeft = ((dayLengthMillis - timeElapsed) / 1000).toFixed(1);
                 infoDisplay.html(`Day: ${dayCounter} | Predators: ${predators.length} | Boids: ${boids.length} | Bugs: ${bugs.length}`);
                 updateCreatureMovement();
            }
        }

        function runHyperMode() {
            const daysPerFrame = 10;
            let daysToSimulateThisFrame = min(daysPerFrame, hyperSimTotalDays - dayCounter + 1);

            for(let i = 0; i < daysToSimulateThisFrame; i++) {
                if (dayCounter >= hyperSimTotalDays) {
                    stopSimulation();
                    return;
                }
                
                const stepsPerDay = 50;
                for (let s = 0; s < stepsPerDay; s++) {
                    updateCreatureMovement();
                }

                endOfDay();
                dayCounter++;
            }
            
            infoDisplay.html(`Simulating... Day ${dayCounter} | Predators: ${predators.length} | Boids: ${boids.length} | Bugs: ${bugs.length}`);
        }
        
        function updateCreatureMovement() {
             // Predator logic
            for (let i = predators.length - 1; i >= 0; i--) {
                let p = predators[i];
                p.update(boids, eggs); // Predators hunt boids and eggs

                // Check if predator eats a boid
                for (let j = boids.length - 1; j >= 0; j--) {
                    if (p.position.dist(boids[j].position) < p.size) {
                        boids.splice(j, 1);
                        p.eat();
                        break; 
                    }
                }
                // Check if predator eats an egg
                for (let j = eggs.length - 1; j >= 0; j--) {
                    if (p.position.dist(eggs[j].position) < p.size) {
                        eggs.splice(j, 1);
                        p.eat();
                        break; 
                    }
                }
            }

             // Boid logic
             for (let i = boids.length - 1; i >= 0; i--) {
                let b = boids[i];
                b.update(bugs, eggs, predators);
                
                // Check if boid eats a bug
                for (let j = bugs.length - 1; j >= 0; j--) {
                    if (b.position.dist(bugs[j].position) < b.size) {
                        bugs.splice(j, 1);
                        b.eat();
                    }
                }
                
                // Check if boid eats an egg
                for (let j = eggs.length - 1; j >= 0; j--) {
                     if (b.position.dist(eggs[j].position) < b.size) {
                        eggs.splice(j, 1);
                        b.eat();
                    }
                }
            }

            // Bug logic
             for (let i = bugs.length - 1; i >= 0; i--) {
                let bug = bugs[i];
                bug.update();
                if (bug.mated) continue;
                for (let j = i - 1; j >= 0; j--) {
                     let otherBug = bugs[j];
                     if (otherBug.mated) continue;
                     if (bug.position.dist(otherBug.position) < bug.size) {
                         if (bug.gender !== otherBug.gender) {
                             eggs.push(new Egg(bug.position.x, bug.position.y));
                             bug.mated = true;
                             otherBug.mated = true;
                             break;
                         }
                     }
                }
            }
        }
        
        function drawBugsAndEggs() {
            for (let b of bugs) { b.display(); }
            for (let e of eggs) { e.display(); }
        }

        function drawBoids() {
             for (let b of boids) { b.display(); }
        }

        function drawPredators() {
            for (let p of predators) { p.display(); }
        }

        function displayPauseMessage() {
            fill(255, 255, 255, 200); rectMode(CENTER);
            rect(width / 2, height / 2, 450, 100, 10);
            fill(0); textAlign(CENTER, CENTER);
            textSize(24); text(`Day ${dayCounter} has ended.`, width / 2, height / 2 - 15);
            textSize(18); text(`Predators: ${predators.length} | Boids: ${boids.length} | Bugs: ${bugs.length}`, width / 2, height / 2 + 15);
        }

        function endOfDay() {
            // Predator EOD Logic
            for (let i = predators.length - 1; i >= 0; i--) {
                let p = predators[i];
                if (dayCounter - p.birthDay > predatorMaxAgeInDays) { predators.splice(i, 1); continue; }
                if (p.foodEatenToday > 0) { p.readyToReproduce = true; }
                p.foodEatenToday = 0;
            }
            for (let i = 0; i < predators.length; i++) {
                for (let j = i + 1; j < predators.length; j++) {
                     let p1 = predators[i]; let p2 = predators[j];
                     if (p1.readyToReproduce && p2.readyToReproduce && p1.gender !== p2.gender && p1.position.dist(p2.position) < p1.size * 2) {
                        predators.push(Predator.reproduce(p1, p2));
                        p1.readyToReproduce = false; p2.readyToReproduce = false;
                     }
                }
            }


            // Boid EOD Logic
            for (let i = boids.length - 1; i >= 0; i--) {
                let b = boids[i];
                if (dayCounter - b.birthDay > boidMaxAgeInDays) { boids.splice(i, 1); continue; }
                if (b.foodEatenToday === 0) { b.daysWithoutFood++; } else { b.daysWithoutFood = 0; }
                if (b.daysWithoutFood >= 3) { boids.splice(i, 1); continue; }
                if (b.foodEatenToday >= 2) { b.setReadyToReproduce(dayCounter); }
                b.foodEatenToday = 0;
            }

            // Bug EOD Logic
             for (let i = bugs.length - 1; i >= 0; i--) {
                if (dayCounter - bugs[i].birthDay > 1) { bugs.splice(i, 1); } 
                else { bugs[i].mated = false; }
            }

            // Egg Hatching Logic
             for (let i = eggs.length - 1; i >= 0; i--) {
                if (dayCounter - eggs[i].laidDay >= 1) { eggs[i].hatch(); eggs.splice(i, 1); }
            }
        }
        
        function startNewDay() {
            isPaused = false;
            dayCounter++;
            dayStartTime = millis();
        }
        
        function initializeUI() {
            // FIX: Initialize all UI element variables once.
            infoDisplay = select('#info-display');
            modeToggle = select('#mode-toggle');
            mainButton = select('#main-button');
            normalControls = select('#normal-controls');
            hyperControls = select('#hyper-controls');
            dayLengthSlider = select('#day-length-slider');
            dayLengthValueSpan = select('#day-length-value');
            yearsInput = select('#years-input');
            daysInput = select('#days-input');
            yearsRadio = select('#years-radio');
            daysRadio = select('#days-radio');
            
            let durationRadios = selectAll('input[name="duration-type"]');
            for(const radio of durationRadios) { radio.changed(updateHyperControls); }
            modeToggle.changed(switchMode);
            mainButton.mousePressed(toggleSimulation);
            dayLengthSlider.input(() => { dayLengthMillis = dayLengthSlider.value() * 1000; dayLengthValueSpan.html(dayLengthSlider.value()); updateInfoDisplay(); });
            yearsInput.input(updateInfoDisplay);
            daysInput.input(updateInfoDisplay);
        }
        
        function switchMode() {
            simulationMode = this.elt.checked ? 'hyper' : 'normal';
            stopSimulation();
            resetSimulation();
        }
        
        function toggleSimulation() {
            if(isSimComplete) { resetSimulation(); return; }
            if(isSimulating) { stopSimulation(); } else { startSimulation(); }
        }
        
        function startSimulation() {
            isSimulating = true;
            resetSimulation();
            if(simulationMode === 'hyper') {
                 mainButton.html('Stop');
                 mainButton.addClass('stop-button');
            } else {
                 mainButton.html('Restart');
            }
        }

        function stopSimulation() {
            isSimulating = false;
            if (simulationMode === 'hyper') {
                isSimComplete = true;
                infoDisplay.html(`Simulation Stopped. Predators: ${predators.length} | Boids: ${boids.length} | Bugs: ${bugs.length}`);
                mainButton.html('Reset');
                mainButton.removeClass('stop-button');
            } else {
                 updateUIState();
            }
        }
        
        function resetSimulation() {
            isSimComplete = false;
            boids = [];
            bugs = [];
            eggs = [];
            predators = [];
            dayCounter = 1;
            dayStartTime = millis();
            isPaused = false;
            
            for (let i = 0; i < initialBoids; i++) {
                boids.push(new Boid(random(width), random(height), (i < initialBoids / 2) ? 'male' : 'female'));
            }
            for (let i = 0; i < initialBugs; i++) {
                bugs.push(new Bug(random(width), random(height), (i < initialBugs / 2) ? 'male' : 'female'));
            }
             for (let i = 0; i < initialPredators; i++) {
                predators.push(new Predator(random(width), random(height), (i < initialPredators / 2) ? 'male' : 'female'));
            }

            if (!isSimulating) {
                updateUIState();
            }
        }
        
        function updateUIState() {
            // FIX: Use global variables instead of calling select() again
            if (simulationMode === 'normal') {
                mainButton.html('Restart');
                normalControls.removeClass('hidden');
                hyperControls.addClass('hidden');
            } else {
                mainButton.html('Start Hyper-Sim');
                normalControls.addClass('hidden');
                hyperControls.removeClass('hidden');
            }
            mainButton.removeClass('stop-button');
            updateHyperControls();
            updateInfoDisplay();
        }
        
        function updateHyperControls() {
            // FIX: Use global variables
            if (yearsRadio.elt.checked) {
                yearsInput.removeAttribute('disabled');
                daysInput.attribute('disabled', '');
            } else {
                yearsInput.attribute('disabled', '');
                daysInput.removeAttribute('disabled');
            }
            updateInfoDisplay();
        }

        function calculateTotalDays() {
            if(simulationMode === 'hyper') {
                 // FIX: Use global variables
                if (yearsRadio.elt.checked) { return yearsInput.value() * daysPerYear; } 
                else { return daysInput.value(); }
            }
            return 0;
        }

        function updateInfoDisplay() {
            if (isSimulating || isSimComplete) return;
            if (simulationMode === 'normal') {
                infoDisplay.html(`Day: 1 | Predators: ${initialPredators} | Boids: ${initialBoids} | Bugs: ${initialBugs}`);
            } else {
                hyperSimTotalDays = calculateTotalDays();
                // FIX: Use global variables
                let unit = yearsRadio.elt.checked ? "years" : "days";
                let amount = yearsRadio.elt.checked ? yearsInput.value() : daysInput.value();
                infoDisplay.html(`Ready for Hyper-Sim of ${amount} ${unit}. Press Start.`);
            }
        }
        
        function mousePressed() {
            if (mouseX > 0 && mouseX < width && mouseY > 0 && mouseY < height && !select('.controls').elt.contains(event.target)) {
                bugs.push(new Bug(mouseX, mouseY, random(1) > 0.5 ? 'male' : 'female'));
            }
        }
        
        function windowResized() {
            resizeCanvas(windowWidth * 0.9, windowHeight * 0.55);
        }

        class Predator {
            constructor(x, y, gender) {
                this.position = createVector(x, y);
                this.velocity = p5.Vector.random2D().setMag(random(1, 1.5));
                this.acceleration = createVector();
                this.maxForce = 0.1; this.maxSpeed = 2.5; this.size = 15;
                this.gender = gender;
                this.birthDay = dayCounter;
                this.foodEatenToday = 0;
                this.readyToReproduce = false;
            }
            eat() { this.foodEatenToday++; }
            static reproduce(p1, p2) {
                let p = p5.Vector.add(p1.position, p2.position).div(2);
                return new Predator(p.x, p.y, random(1) > 0.5 ? 'male' : 'female');
            }
            seek(target) {
                let desired = p5.Vector.sub(target, this.position).setMag(this.maxSpeed);
                return p5.Vector.sub(desired, this.velocity).limit(this.maxForce);
            }
            update(boidList, eggList) {
                let closestTarget = null; let closestDist = Infinity;
                for (let b of boidList) {
                    let d = this.position.dist(b.position);
                    if (d < closestDist) { closestDist = d; closestTarget = b; }
                }
                for (let e of eggList) {
                     let d = this.position.dist(e.position);
                    if (d < closestDist) { closestDist = d; closestTarget = e; }
                }

                if (closestTarget) { this.acceleration.add(this.seek(closestTarget.position)); }

                this.velocity.add(this.acceleration);
                this.velocity.limit(this.maxSpeed);
                this.position.add(this.velocity);
                this.acceleration.mult(0);
                this.boundaries();
            }
             boundaries() {
                if (this.position.x < 0) this.position.x = width; if (this.position.y < 0) this.position.y = height;
                if (this.position.x > width) this.position.x = 0; if (this.position.y > height) this.position.y = 0;
            }
            display() {
                let angle = this.velocity.heading() + PI / 2;
                push();
                translate(this.position.x, this.position.y); rotate(angle);
                let predColor = (this.gender === 'male') ? color(255, 50, 50) : color(200, 0, 0);
                if (this.readyToReproduce) { stroke(255); } else { stroke(150); }
                fill(predColor);
                strokeWeight(1.5);
                beginShape();
                vertex(0, -this.size); vertex(-this.size, this.size); vertex(this.size, this.size);
                endShape(CLOSE);
                pop();
            }
        }
        
        class Boid {
            constructor(x, y, gender) {
                this.position = createVector(x, y);
                this.velocity = p5.Vector.random2D().setMag(random(1, 2.5));
                this.acceleration = createVector();
                this.maxForce = 0.2; this.maxSpeed = 3; this.size = 12;
                this.gender = gender;
                this.birthDay = dayCounter;
                this.foodEatenToday = 0; this.readyToReproduceUntilDay = -1;
                this.daysWithoutFood = 0;
            }
            eat() { this.foodEatenToday++; }
            setReadyToReproduce(cd) { this.readyToReproduceUntilDay = cd + 7; }
            isReadyToReproduce(cd) { return cd <= this.readyToReproduceUntilDay; }
            resetReproduction() { this.readyToReproduceUntilDay = -1; }
            static reproduce(b1, b2) {
                let p = p5.Vector.add(b1.position, b2.position).div(2);
                return new Boid(p.x, p.y, random(1) > 0.5 ? 'male' : 'female');
            }
            seek(target) {
                let desired = p5.Vector.sub(target, this.position).setMag(this.maxSpeed);
                return p5.Vector.sub(desired, this.velocity).limit(this.maxForce);
            }
             flee(target) {
                return this.seek(target).mult(-1);
            }
            update(bugList, eggList, predatorSource) {
                let closestPredator = null; let closestPredDist = Infinity;
                for (let p of predatorSource) {
                    let d = this.position.dist(p.position);
                    if (d < closestPredDist) { closestPredDist = d; closestPredator = p; }
                }

                if (closestPredator && closestPredDist < 100) {
                    this.acceleration.add(this.flee(closestPredator.position));
                } else {
                     let closestFood = null; let closestFoodDist = Infinity;
                    
                    for (let f of bugList) {
                        let d = this.position.dist(f.position);
                        if (d < closestFoodDist) { closestFoodDist = d; closestFood = f; }
                    }
                    for (let f of eggList) {
                        let d = this.position.dist(f.position);
                        if (d < closestFoodDist) { closestFoodDist = d; closestFood = f; }
                    }

                    if (closestFood) { this.acceleration.add(this.seek(closestFood.position)); }
                }
                
                this.velocity.add(this.acceleration);
                this.velocity.limit(this.maxSpeed);
                this.position.add(this.velocity);
                this.acceleration.mult(0);
                this.boundaries();
            }
            boundaries() {
                if (this.position.x < 0) this.position.x = width; if (this.position.y < 0) this.position.y = height;
                if (this.position.x > width) this.position.x = 0; if (this.position.y > height) this.position.y = 0;
            }
            display() {
                let angle = this.velocity.heading() + PI / 2;
                push();
                translate(this.position.x, this.position.y); rotate(angle);
                let boidColor = (this.gender === 'male') ? color(100, 100, 255) : color(255, 100, 150);
                if (this.isReadyToReproduce(dayCounter)) { stroke(255); } else { stroke(200); }
                fill(boidColor);
                strokeWeight(1);
                beginShape();
                vertex(0, -this.size); vertex(-this.size / 2, this.size / 2); vertex(this.size / 2, this.size / 2);
                endShape(CLOSE);
                pop();
            }
        }

        class Bug {
            constructor(x, y, gender) {
                this.position = createVector(x, y);
                this.velocity = p5.Vector.random2D().setMag(random(0.5, 1.5));
                this.size = 5; this.gender = gender; this.birthDay = dayCounter; this.mated = false;
            }
            update() { this.position.add(this.velocity); this.boundaries(); }
            boundaries() {
                if (this.position.x < 0 || this.position.x > width) this.velocity.x *= -1;
                if (this.position.y < 0 || this.position.y > height) this.velocity.y *= -1;
            }
            display() {
                push();
                translate(this.position.x, this.position.y);
                fill(139, 69, 19); noStroke();
                ellipse(0, 0, this.size, this.size);
                pop();
            }
        }

        class Egg {
            constructor(x, y) {
                this.position = createVector(x, y);
                this.laidDay = dayCounter; this.size = 10;
            }
            hatch() {
                for(let i = 0; i < 100; i++) {
                    bugs.push(new Bug(this.position.x + random(-5, 5), this.position.y + random(-5, 5), random(1) > 0.5 ? 'male' : 'female'));
                }
            }
            display() {
                push();
                translate(this.position.x, this.position.y);
                fill(245, 245, 220); stroke(200);
                ellipse(0, 0, this.size, this.size * 1.2);
                pop();
            }
        }
    </script>
</body>
</html>
